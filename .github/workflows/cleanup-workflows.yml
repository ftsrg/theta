name: Cleanup old workflow runs (gh CLI)

on:
  schedule:
    # weekly on Sunday 00:00 UTC
    - cron: '0 0 * * 0'
  workflow_dispatch:

permissions:
  actions: write
  contents: read

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Install dependencies (gh, jq)
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq gh

      - name: Delete workflow runs older than 60 days (using gh)
        env:
          DAYS: "60"                       # threshold in days (change to 60 for two months)
          REPO: ${{ github.repository }}   # owner/repo
          DRY_RUN: "false"                 # set "true" to preview without deletingenv:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail

          owner_repo="$REPO"
          days="$DAYS"
          dry_run="${DRY_RUN,,}"   # lower-case

          # cutoff in ISO8601 (UTC). GNU date is available on ubuntu-latest runner.
          cutoff=$(date -u -d "${days} days ago" +%Y-%m-%dT%H:%M:%SZ)
          echo "Repository: $owner_repo"
          echo "Cutoff (delete if created before): $cutoff (older than $days days)"
          echo "Dry run: $dry_run"

          per_page=100

          echo "Fetching workflow runs and filtering by created_at < $cutoff ..."

          # Use gh api to stream each workflow_run as JSON, then let jq (with --arg) compare timestamps.
          # This avoids complex quoting and is robust to special characters.
          gh api "repos/${owner_repo}/actions/runs?per_page=${per_page}" --paginate --jq '.workflow_runs[]' \
            | jq -c --arg cutoff "$cutoff" 'select(.created_at < $cutoff)' \
            | while IFS= read -r run_json; do
                # Extract fields reliably using jq again
                run_id=$(jq -r '.id' <<<"$run_json")
                run_name=$(jq -r '.name // ""' <<<"$run_json")
                run_url=$(jq -r '.html_url // ""' <<<"$run_json")
                run_created=$(jq -r '.created_at' <<<"$run_json")

                echo "Found old run: id=$run_id created=$run_created name=\"$run_name\" url=$run_url"

                if [ "$dry_run" = "true" ] || [ "$dry_run" = "1" ]; then
                  echo "  -> dry-run: would delete run $run_id"
                else
                  echo "  -> deleting run $run_id ..."
                  # Delete via gh api. Check exit code for success (204 -> success).
                  if gh api -X DELETE "repos/${owner_repo}/actions/runs/${run_id}"; then
                    echo "  -> deleted $run_id"
                  else
                    echo "  -> failed to delete $run_id"
                    # Optional: inspect headers / Retry-After, or backoff here
                  fi
                  sleep 0.2
                fi
              done

          echo "Done."